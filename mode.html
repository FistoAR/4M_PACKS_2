<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Model Texture Export</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        model-viewer {
            width: 600px;
            height: 400px;
            display: block;
            margin-bottom: 1em;
        }

        button {
            padding: 10px 20px;
            font-size: 1em;
        }
    </style>
</head>

<body>

    <model-viewer id="viewer" src="./assets/glb/round/120ml_round.glb" alt="3D model" ar auto-rotate camera-controls
        exposure="1" shadow-intensity="1" environment-image="neutral">
    </model-viewer>

    <button id="downloadBtn">Download Texture as PNG</button>
    <script type="module">
        const viewer = document.getElementById('viewer');
        const button = document.getElementById('downloadBtn');

        button.addEventListener('click', async () => {
            // Wait for the model to be ready
            await viewer.updateComplete;
            const model = viewer.model; // SceneGraph API

            if (!model) {
                alert("3D model is not loaded yet.");
                return;
            }

            // Find the material named "texture_area"
            let targetTexture = null;
            for (const material of model.materials) {
                if (material.name === "texture_area" &&
                    material.pbrMetallicRoughness &&
                    material.pbrMetallicRoughness.baseColorTexture &&
                    material.pbrMetallicRoughness.baseColorTexture.texture) {
                    targetTexture = material.pbrMetallicRoughness.baseColorTexture.texture;
                    break;
                }
            }

            if (!targetTexture) {
                alert("Material 'texture_area' with a texture was not found.");
                return;
            }

            // The image may be HTMLImageElement or ImageBitmap
            const image = targetTexture.source.source;
            if (!image || !image.width || !image.height) {
                alert("Texture image is not accessible.");
                return;
            }

            // Draw onto a canvas and export as PNG
            const canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0);

            canvas.toBlob(blob => {
                if (!blob) {
                    alert("Failed to convert texture to PNG.");
                    return;
                }
                const link = document.createElement('a');
                link.download = "texture_area.png";
                link.href = URL.createObjectURL(blob);
                link.click();
                setTimeout(() => URL.revokeObjectURL(link.href), 1000);
            }, 'image/png');
        });
    </script>

    <!-- <script>
  const viewer = document.getElementById('viewer');
  const button = document.getElementById('downloadBtn');

  button.addEventListener('click', () => {
    const gltfScene = viewer.scene;

    if (!gltfScene) {
      console.error("viewer.scene is not available.");
      alert("Scene not available.");
      return;
    }

    const materialName = "texture_area";
    let targetTexture = null;

    gltfScene.traverse((object) => {
      if (object.isMesh && object.material) {
        const materials = Array.isArray(object.material) ? object.material : [object.material];
        materials.forEach(mat => {
          if (mat.name === materialName && mat.map) {
            console.log("Found material:", mat.name);
            targetTexture = mat.map;
          }
        });
      }
    });

    if (!targetTexture) {
      alert(`Material '${materialName}' with a texture was not found.`);
      return;
    }

    const image = targetTexture.image;

    if (!image || !image.width || !image.height) {
      alert("Texture image is not accessible.");
      return;
    }

    const canvas = document.createElement('canvas');
    canvas.width = image.width;
    canvas.height = image.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(image, 0, 0);

    canvas.toBlob((blob) => {
      const link = document.createElement('a');
      link.download = `${materialName}.png`;
      link.href = URL.createObjectURL(blob);
      link.click();
    }, 'image/png');
  });
</script> -->

</body>

</html>